<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit News</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h2>Edit News</h2>
        <form id="editNewsForm">
            <div class="form-group">
                <label for="newsName">News Name:</label>
                <input type="text" class="form-control" id="newsName" required>
            </div>
            <div class="form-group">
                <label for="newsDetails">Details:</label>
                <textarea class="form-control" id="newsDetails" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="newsDate">Date:</label>
                <input type="date" class="form-control" id="newsDate" required>
            </div>
            <div class="form-group">
                <label for="catId">Category:</label>
                <select class="form-control" id="catId" required>
                </select>
            </div>

            <div id="subCatsContainer" class="mb-3">
            </div>

            <div class="form-group">
                <label for="majorId">Major:</label>
                <select class="form-control" id="majorId" required>
                    <!-- Major options will be loaded here -->
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Update News</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const newsId = new URLSearchParams(window.location.search).get('id');
            fetch(`http://localhost:5000/api/news/${newsId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('newsName').value = data.News_Name;
                    document.getElementById('newsDetails').value = data.News_Details;
                    document.getElementById('newsDate').value = data.Date_Added.substr(0, 10);  // Assumes Date_Added is in a suitable format
                    document.getElementById('catId').value = data.Cat_Id;
                    document.getElementById('majorId').value = data.Major_Id;

                    // Load sub categories
                    fetch(`http://localhost:5000/api/sub_category/${data.Cat_Id}`)
                        .then(response => response.json())
                        .then(subCategories => {
                            const subCatContainer = document.getElementById('subCatsContainer');
                            subCategories.forEach(subCat => {
                                const subCatSelect = document.createElement('select');
                                subCatSelect.className = 'form-control subCatSelect';
                                subCatSelect.required = true;
                                subCatSelect.value = subCat.Sub_Cat_Id;

                                const option = document.createElement('option');
                                option.value = subCat.Sub_Cat_Id;
                                option.textContent = subCat.Sub_Cat_Name;
                                subCatSelect.appendChild(option);
                                subCatContainer.appendChild(subCatSelect);
                            });
                        })
                        .catch(error => console.error('Failed to load sub categories:', error));
                })
                .catch(error => console.error('Failed to load news data:', error));

            // Load category options
            document.addEventListener('DOMContentLoaded', function () {
                fetch('http://localhost:5000/api/category')
                    .then(response => response.json())
                    .then(data => {
                        const select = document.getElementById('catId');
                        data.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.Cat_Id;
                            option.textContent = category.Cat_Name;
                            select.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Failed to load categories:', error));
            });

            // Load major options
            document.addEventListener('DOMContentLoaded', function () {
                fetch('http://localhost:5000/api/major')
                    .then(response => response.json())
                    .then(data => {
                        const select = document.getElementById('majorId');
                        data.forEach(major => {
                            const option = document.createElement('option');
                            option.value = major.Major_Id;
                            option.textContent = major.Major_Level;
                            select.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Failed to load major:', error));
            });

            document.getElementById('editNewsForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const updatedData = {
                    News_Name: document.getElementById('newsName').value,
                    News_Details: document.getElementById('newsDetails').value,
                    Date_Added: document.getElementById('newsDate').value,
                    Cat_Id: document.getElementById('catId').value,
                    Major_Id: document.getElementById('majorId').value
                };

                // Update sub categories
                const subCatIds = [];
                document.querySelectorAll('.subCatSelect').forEach(select => {
                    subCatIds.push(select.value);
                });
                updatedData.Sub_Cat_Ids = subCatIds;

                fetch(`http://localhost:5000/api/news/${newsId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to update news.');
                        alert('News updated successfully.');
                        window.location.href = 'news.html';  // Redirect to news overview page
                    })
                    .catch(error => {
                        console.error('Error updating news:', error);
                        alert('Error updating news: ' + error.message);
                    });
            });
        });

    </script>
</body>

</html>